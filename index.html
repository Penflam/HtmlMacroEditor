<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestionnaire de macros Pantheon</title>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f5f5f5; }

    /* Dropzone */
    .dropzone {
      border: 3px dashed #888; padding: 2em; text-align: center; background: #fff;
      margin-bottom: 2em; transition: background .2s, border-color .2s;
    }
    .dropzone.hover { border-color: #007bff; background: #eef5ff; }

    /* Messages */
    .message { margin-top: 1em; font-weight: bold; }

    /* Tableau */
    table { border-collapse: collapse; width: 100%; background: #fff; margin-top: .5em; }
    th, td { border: 1px solid #ccc; padding: .5em; vertical-align: top; }
    input[type="text"] { width: 95%; }
    textarea { width: 95%; height: 4em; font-family: monospace; white-space: pre-wrap; resize: vertical; }
    .actions button { margin: 0 .15em; }

    /* Indicateur de prÃ©sence dans JSON courant */
    .in-current { background: #eaffea; }
    .not-in-current { background: #ffecec; }

    /* Barres d'outils */
    .tools { margin: 1.5em 0; display: flex; flex-wrap: wrap; gap: .5em; align-items: center; }
    .tools input[type="file"] { display: none; }

    details { margin-top: 1.5em; }
  </style>
</head>
<body>
  <h1>Importation de macros JSON</h1>
  <div class="dropzone" id="dropzone">Glissez un fichier CharacterSettings.json ici<br>ils se trouvent ici:<br> C:\Users\<b>VotreNom</b>\AppData\LocalLow\Visionary Realms\Pantheon\Settings\CharacterSettings\</div>
  <div class="message" id="message"></div>

  <!-- Outils complÃ©mentaires -->
  <div class="tools">
    <input type="text" id="searchInput" placeholder="Filtrer les macrosâ€¦" />
    <button id="resetBtn">RÃ©initialiser les macros</button>
    <button id="exportMacrosBtn">Exporter macros (backup)</button>
    <input type="file" id="importMacrosFile" accept="application/json" style="display: none;" />
<button id="importMacrosBtn">Importer macros (backup)</button>
  </div>

  <!-- Tableau des macros -->
  <h2>Macros en localStorage</h2>
  <table id="macroTable">
    <thead><tr><th>Nom</th><th>Texte</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>

  <!-- Formulaire d'ajout -->
  <form id="addForm">
    <input type="text" id="newMacroName" placeholder="Nom de la macro" required />
    <textarea id="newMacroText" placeholder="Texte de la macro" required></textarea><br/>
    <button type="submit">Ajouter</button>
    <button type="button" id="exportBtn">Exporter JSON courant</button>
  </form>

  <!-- Sections pour WindowSettingValues & WindowLocations -->
  <details id="wsSection" hidden>
    <summary>WindowSettingValues (<span id="wsCount"></span>)</summary>
    <pre id="wsContent"></pre>
  </details>
  <details id="wlSection" hidden>
    <summary>WindowLocations (<span id="wlCount"></span>)</summary>
    <pre id="wlContent"></pre>
  </details>

  <script>
        console.log(window)
    /* -------------------------------------------------------------- */
    // Ã‰tat courant
    let currentJson = null;      // JSON actuellement chargÃ©
    let currentMacros = [];      // Alias sur currentJson.Macros
    let windowSettings = [];
    let windowLocations = [];

    /* -------------------------------------------------------------- */
    // Utilitaires DOM & stockage
    const $ = (sel) => document.querySelector(sel);

    function showMessage(msg, isError = false) {
      const el = $('#message');
      el.textContent = msg;
      el.style.color = isError ? 'red' : 'green';
    }

    function getStoredMacros() {
      return JSON.parse(localStorage.getItem('storedMacros') || '[]');
    }

    function saveStoredMacros(macros) {
      localStorage.setItem('storedMacros', JSON.stringify(macros));
    }

    function mergeMacros(existing, incoming) {
      const map = new Map(existing.map(m => [m.MacroName.toLowerCase(), m]));
      incoming.forEach(m => map.set(m.MacroName.toLowerCase(), m));
      return [...map.values()];
    }

    /* -------------------------------------------------------------- */
    // Rendus
    function escapeHTML(txt) {
      return txt.replaceAll('&', '&amp;').replaceAll('<', '&lt;');
    }

    function inCurrentJson(name) {
      return currentJson && currentMacros.some(m => m.MacroName.toLowerCase() === name.toLowerCase());
    }

    function updateMacroTable() {
      const tbody = $('#macroTable tbody');
      tbody.innerHTML = '';
      const macros = getStoredMacros();
      const hasCurrent = !!currentJson;

      macros.forEach((macro, index) => {
        const inCurrent = inCurrentJson(macro.MacroName);
        const row = document.createElement('tr');
        row.className = inCurrent ? 'in-current' : 'not-in-current';
        row.innerHTML = `
          <td><input type="text" value="${escapeHTML(macro.MacroName)}" data-index="${index}" class="edit-name"/></td>
          <td><textarea data-index="${index}" class="edit-text">${escapeHTML(macro.MacroText)}</textarea></td>
          <td class="actions">
            <button onclick="saveEdit(${index})" title="Sauvegarder">ðŸ’¾</button>
            <button onclick="deleteMacro(${index})" title="Supprimer du stockage">ðŸ—‘</button>
            <button onclick="removeFromCurrent(${index})" title="Supprimer du JSON courant" ${inCurrent ? '' : 'disabled'}>âž–</button>
            <button onclick="addToCurrent(${index})" title="Ajouter au JSON courant" ${inCurrent || !hasCurrent ? 'disabled' : ''}>âž•</button>
          </td>`;
        tbody.appendChild(row);
      });
      applyFilter();
    }

    function renderSettingsSections() {
      if (windowSettings && windowSettings.length) {
        $('#wsSection').hidden = false;
        $('#wsCount').textContent = windowSettings.length;
        $('#wsContent').textContent = JSON.stringify(windowSettings, null, 2);
      }
      if (windowLocations && windowLocations.length) {
        $('#wlSection').hidden = false;
        $('#wlCount').textContent = windowLocations.length;
        $('#wlContent').textContent = JSON.stringify(windowLocations, null, 2);
      }
    }

    /* -------------------------------------------------------------- */
    // CRUD stockage
    window.saveEdit = function(index) {
      const name = document.querySelector(`.edit-name[data-index='${index}']`).value.trim();
      const text = document.querySelector(`.edit-text[data-index='${index}']`).value;
      if (!name) return showMessage('Nom de macro vide.', true);

      let macros = getStoredMacros();
      if (macros.some((m, i) => i !== index && m.MacroName.toLowerCase() === name.toLowerCase())) {
        return showMessage('Un autre macro porte dÃ©jÃ  ce nom.', true);
      }
      const oldName = macros[index].MacroName.toLowerCase();
      macros[index] = { MacroName: name, MacroText: text };
      saveStoredMacros(macros);

      // maj JSON courant si prÃ©sent
      if (currentJson) {
        const idxCur = currentMacros.findIndex(m => m.MacroName.toLowerCase() === oldName);
        if (idxCur !== -1) currentMacros[idxCur] = { MacroName: name, MacroText: text };
      }
      updateMacroTable();
      showMessage('Macro mise Ã  jour.');
    };

    window.deleteMacro = function(index) {
      if (!confirm('Supprimer cette macro du stockageÂ ?')) return;
      let macros = getStoredMacros();
      const removed = macros.splice(index, 1)[0];
      saveStoredMacros(macros);

      if (currentJson) {
        currentJson.Macros = currentJson.Macros.filter(m => m.MacroName.toLowerCase() !== removed.MacroName.toLowerCase());
        currentMacros = currentJson.Macros;
      }
      updateMacroTable();
      showMessage('Macro supprimÃ©e du stockage.');
    };

    /* -------------------------------------------------------------- */
    // Actions sur JSON courant
    window.removeFromCurrent = function(index) {
      if (!currentJson) return showMessage('Aucun JSON courant chargÃ©.', true);
      const macro = getStoredMacros()[index];
      currentJson.Macros = currentJson.Macros.filter(m => m.MacroName.toLowerCase() !== macro.MacroName.toLowerCase());
      currentMacros = currentJson.Macros;
      updateMacroTable();
      showMessage('Macro retirÃ©e du JSON courant.');
    };

    window.addToCurrent = function(index) {
      if (!currentJson) return showMessage('Aucun JSON courant chargÃ©.', true);
      const macro = getStoredMacros()[index];
      if (inCurrentJson(macro.MacroName)) {
        return showMessage('Macro dÃ©jÃ  prÃ©sente dans le JSON courant.', true);
      }
      currentJson.Macros.push({ ...macro });
      currentMacros = currentJson.Macros;
      updateMacroTable();
      showMessage('Macro ajoutÃ©e au JSON courant.');
    };

    /* -------------------------------------------------------------- */
    // Import / export stockage
    function exportStoredMacros() {
      const macros = getStoredMacros();
      if (!macros.length) return showMessage('Aucune macro Ã  exporter.', true);
      const blob = new Blob([JSON.stringify(macros, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Macros_backup.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function importStoredMacros(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const incoming = JSON.parse(e.target.result);
          if (!Array.isArray(incoming)) throw new Error();
          const merged = mergeMacros(getStoredMacros(), incoming);
          saveStoredMacros(merged);
          updateMacroTable();
          showMessage(`${incoming.length} macros importÃ©es depuis le backup. Total : ${merged.length}.`);
        } catch {
          showMessage('Fichier de backup invalide.', true);
        }
      };
      reader.readAsText(file);
    }

    /* -------------------------------------------------------------- */
    // Gestion JSON courant via drag & drop
    function handleFileDrop(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const json = JSON.parse(e.target.result);
          if (!json.Macros || !json.WindowSettingValues || !json.WindowLocations) {
            return showMessage('Fichier JSON invalide.', true);
          }
          currentJson = json;
          currentMacros = json.Macros;
          windowSettings = json.WindowSettingValues;
          windowLocations = json.WindowLocations;

          const merged = mergeMacros(getStoredMacros(), currentMacros);
          saveStoredMacros(merged);
          updateMacroTable();
          renderSettingsSections();
          showMessage(`${currentMacros.length} macros importÃ©es. Total stock : ${merged.length}.`);
        } catch {
          showMessage('Erreur lors de la lecture du fichier JSON.', true);
        }
      };
      reader.readAsText(file);
    }

    function initDropzone() {
      const dropzone = document.getElementById('dropzone');
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('hover');
      });
      dropzone.addEventListener('dragleave', () => dropzone.classList.remove('hover'));
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('hover');
        const file = e.dataTransfer.files[0];
        if (file && file.type === 'application/json') {
          handleFileDrop(file);
        } else {
          showMessage('Veuillez dÃ©poser un fichier JSON.', true);
        }
      });
    }

    function applyFilter() {
      const term = $('#searchInput').value.toLowerCase();
      const rows = $('#macroTable tbody').querySelectorAll('tr');
      rows.forEach((row) => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      $('#importMacrosBtn').addEventListener('click', () => {
        $('#importMacrosFile').click();
      });
      initDropzone();
      updateMacroTable();

      $('#addForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const name = $('#newMacroName').value.trim();
        const text = $('#newMacroText').value;
        if (!name) return showMessage('Le nom ne peut pas Ãªtre vide.', true);
        let macros = getStoredMacros();
        if (macros.some((m) => m.MacroName.toLowerCase() === name.toLowerCase())) {
          return showMessage('Nom de macro dÃ©jÃ  existant.', true);
        }
        macros.push({ MacroName: name, MacroText: text });
        saveStoredMacros(macros);
        updateMacroTable();
        showMessage('Macro ajoutÃ©e.');
        e.target.reset();
      });

      $('#exportBtn').addEventListener('click', () => {
        if (!currentJson) return showMessage('Aucun JSON chargÃ© Ã  exporter.', true);
        currentJson.Macros = getStoredMacros().filter(macro =>
          currentJson.Macros.some(jm => jm.MacroName.toLowerCase() === macro.MacroName.toLowerCase())
        );
        const blob = new Blob([JSON.stringify(currentJson, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'CharacterSettings.json';
        a.click();
        URL.revokeObjectURL(url);
      });

      $('#searchInput').addEventListener('input', applyFilter);
      $('#resetBtn').addEventListener('click', () => {
        if (!confirm('Vider complÃ¨tement les macros enregistrÃ©es ?')) return;
        localStorage.removeItem('storedMacros');
        updateMacroTable();
        showMessage('Macros rÃ©initialisÃ©es.');
      });

      $('#exportMacrosBtn').addEventListener('click', exportStoredMacros);
      $('#importMacrosFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) importStoredMacros(file);
        e.target.value = '';
      });
    });
  </script>
</body>
</html>
